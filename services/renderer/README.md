# Микросервис генерации расписаний

Микросервис предназначен для фоновой генерации расписания на основе изображений, сохраненных в NATS Object Storage и переданных данных.


## Переменные окружения

Для работы микросервиса необходимо задать следующие переменные окружения:

- `NATS_SERVERS`: Адрес брокера NATS для подключения. Обязательный параметр. Пример: `nats://nats:4222`.
- `DB_URL`: Ссылка для обращения к базе данных. Необязательный параметр, но если не указано, то будут работать только шаблоны, включающие текстовые элементы и изображения с заполненным `element_id` вместо `name`
- `LC_TIME`: Переменная, контролирующая локаль для вывода даты и времени. Должно быть `ru_RU.UTF-8`, т. к. в данный момент другие локали не поддерживаются докер-образом `schedule_bot`.


## Запуск

Для запуска микросервиса запустите докер-образ `schedule_bot`, переопределив `entrypoint` следующим образом: `["python3", "-m", "services.renderer"]`.
Убедитесь, что переменные окружения `NATS_SERVERS`, `DB_URL`, `LC_TIME` заданы.


## Обработка сообщений

### Генерация расписания

- **Топик**: `schedules.request`
- **Заголовок `Sch-User-Id`**: Идентификатор пользователя Telegram. Копируется в исходящее сообщение.
- **Заголовок `Sch-Chat-Id`**: Идентификатор чата Telegram. Копируется в исходящее сообщение.
- **Заголовок `Sch-Start-Date`**: Первый день недели, на которую генерируется расписание в формате ISO. Ожидается, что это будет понедельник. Пример: `2024-08-16`
- **Заголовок `Sch-Element-Name`**: Имя, под которым нужное фоновое изображение сохранено в NATS Object Storage
- **Тело**: Бинарные данные. При чтении тела сообщения `msgpack` должен возвращаться список из двух словарей, первый из которых является представлением шаблона ([Template](templates.py)), второй - представлением расписания ([Schedule](weekdays.py))

Микросервис сделает следующее:
- Загрузит фоновое изображение из NATS Object Storage;
- Проанализировав шаблон и расписание, определит, какие текстовые и графические элементы нужно наложить на фоновое изображение;
- Последовательно наложит на изображение каждый элемент. Для графических элементов также выполняется разрешение `element_id` по `name` (если необходимо; требуется указание переменной окружения `DB_URL`) и загрузка изображения из NATS Object Storage по `element_id`;
- В случае успешной генерации расписания публикует сообщение в топик `schedules.ready`, отправив в качестве тела сгенерированное изображение в формеате PNG;
- В случае возникновения ошибки публикует сообщение в топик `schedules.error`, отправив в качестве тела описание ошибки.
