# Микросервис конвертации изображений

Микросервис предназначен для фоновой конвертации и сохранения изображений, присланных пользователем.


## Переменные окружения

Для работы микросервиса необходимо задать следующие переменные окружения:

- `TOKEN`: Токен бота Telegram, которому изначально были присланы файлы. Обязательный параметр.
- `NATS_SERVERS`: Адрес брокера NATS для подключения. Обязательный параметр. Пример: `nats://nats:4222`.


## Запуск

Для запуска микросервиса запустите докер-образ `schedule_bot`, переопределив `entrypoint` следующим образом: `["python3", "-m", "services.converter"]`.
Убедитесь, что переменные окружения `TOKEN` и `NATS_SERVERS` заданы.


## Обработка сообщений

### Конвертация изображения по `file_id`

- **Топик**: `assets.convert.file_id`
- **Заголовок `Sch-Save-Name`**: Имя, с которым будет сохранено подготовленное изображение
- **Заголовок `Sch-Target-Size`**: Целевые ширина и высота изображения после подготовки в виде списка из двух чисел в формате JSON. Пример: `[1920,1098]`
- **Заголовок `Sch-Resize-Mode`**: Способ подготовки изображения. Поддерживаемые варианты: `resize` (растянуть или сжать до целевого размера), `crop` (обрезать до нужного размера либо залить черным фоном), `ignore` (не менять размер изображения)
- **Тело**: Полученный ботом `file_id` (присылается как часть сообщения при загрузке). Этот `file_id` должен относиться к изображению в любом поддерживаемом формате, присланному в виде картинки либо документа

Микросервис скачает картинку из telegram, подготовит в соответствии с заголовками и сохранит результат в формате PNG в NATS Object Store `assets`.

### Конвертация изображения по содержимому

> [!TIP]
> Не рекомендуется использовать этот способ из-за ограничений на размер сообщения в NATS.

- **Топик**: `assets.convert.raw`
- **Заголовок `Sch-Save-Name`**: Имя, с которым будет сохранено подготовленное изображение
- **Заголовок `Sch-Target-Size`**: Целевые ширина и высота изображения после подготовки в виде списка из двух чисел в формате JSON. Пример: `[1920,1098]`
- **Заголовок `Sch-Resize-Mode`**: Способ подготовки изображения. Поддерживаемые варианты: `resize` (растянуть или сжать до целевого размера), `crop` (обрезать до нужного размера либо залить черным фоном), `ignore` (не менять размер изображения)
- **Тело**: Бинарные данные. Ожидается, что это будет изображение в любом поддерживаемом формате

Микросервис прочитает изображение, подготовит в соответствии с заголовками и сохранит результат в формате PNG в NATS Object Store `assets`.
